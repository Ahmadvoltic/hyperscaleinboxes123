# MongoDB Integration Setup

## Environment Variables

Add the following to your `.env` or `.env.local` file:

```env
MONGODB_URI=mongodb://localhost:27017/hyperscaleinboxes
```

Or for MongoDB Atlas (cloud):
```env
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/hyperscaleinboxes?retryWrites=true&w=majority
```

## How Order ID is Generated

**Order ID = Stripe Checkout Session ID**

- The order ID is automatically generated by Stripe when a checkout session is created
- It's a unique identifier like: `cs_test_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`
- This ensures uniqueness and prevents duplicates
- The same session ID is used as both `orderId` and `stripeSessionId` in the database

## Deduplication Logic

The webhook implements deduplication at the database level:

1. **Before saving an order**, the webhook checks if an order with the same `orderId` (Stripe session ID) already exists
2. **If found**: The webhook returns early and doesn't save a duplicate
3. **If not found**: The order is saved to the database

This prevents:
- Duplicate orders from webhook retries
- Multiple webhook deliveries for the same event
- Race conditions if Stripe sends the same event multiple times

## Database Schema

### Order Collection
- `orderId` (unique, indexed) - Stripe session ID
- `stripeSessionId` (unique, indexed) - Same as orderId
- `stripeCustomerId` (indexed) - Stripe customer ID
- `stripeSubscriptionId` (indexed) - Stripe subscription ID
- Customer information (name, email, phone, company)
- Order details (package type, domains, quantity, amount)
- Domain information (custom/selected domains)
- Account names (stored as JSON string)
- Status and timestamps

### CheckoutSession Collection (Temporary)
- Stores `accountNames` temporarily (expires after 24 hours)
- Auto-deleted by MongoDB TTL index
- Used to pass account names from checkout to webhook

## Testing

1. Make sure MongoDB is running
2. Set `MONGODB_URI` in your `.env` file
3. Submit a test order
4. Check your MongoDB database for the saved order
5. Try submitting the same order again - it should be deduplicated

## Troubleshooting

### "MongoDB connection failed"
- Check your `MONGODB_URI` is correct
- Ensure MongoDB is running (if local)
- Check network connectivity (if Atlas)

### "Order already exists" message
- This is normal - it means deduplication is working
- The webhook received a duplicate event and prevented saving

### Account names not saved
- Check that `CheckoutSession` collection exists
- Verify TTL index is created (auto-deletes after 24h)
- Check webhook logs for errors

